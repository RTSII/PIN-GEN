<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>RTS-PIN</title>
    <!-- ...other meta, styles, and links as before... -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@700&family=Roboto+Mono:wght@700&display=swap" rel="stylesheet">
    <style>
        /* ...all your CSS unchanged... */
    </style>
</head>
<body>
    <div class="app-container">
        <!-- ...all your HTML as before... -->
    </div>
    <script>
    (function() {
        'use strict';
        // Constants
        const MAX_PIN_GENERATION_ATTEMPTS = 100000, PIN_LENGTH = 5, PIN_PREFIX_LENGTH = 4;
        const APP_STORAGE_KEY = 'robsPinBotData_v12', FAILED_PIN_VALUE = "Failed";
        const STATUS_MESSAGE_TIMEOUT_MS = 5000;

        // State
        const appState = {
            newSchedule: [],
            usedPINs: new Set(),
            deferredPrompt: null,
            allCompanyUnits: [],
            currentModalCompany: null
        };

        // Forbidden prefixes (unchanged)
        const FORBIDDEN_PIN_PREFIXES = new Set([
            /* ... (same as before) ... */
        ]);
        // Rental data (unchanged)
        const rentalData = { 
            /* ... (same as before) ... */
        };

        // --- Utility Functions ---
        function hexToRgbArray(hex) {
            hex = hex.replace(/^#/, '');
            if (hex.length === 3) hex = hex.split('').map(x => x + x).join('');
            if (hex.length !== 6) return [0,0,0];
            return [0,2,4].map(i => parseInt(hex.slice(i,i+2),16));
        }
        function getMonthName(monthIndex) {
            return ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"][monthIndex];
        }
        function populateAllCompanyUnits() {
            appState.allCompanyUnits = Array.from(
                Object.values(rentalData).flat()
            ).sort();
        }
        function saveDataToLocalStorage() {
            try {
                const currentMonth = document.getElementById('month-select').value,
                      currentYear = document.getElementById('year-select').value;
                const dataToSave = {
                    newSchedule: appState.newSchedule,
                    usedPINs: Array.from(appState.usedPINs),
                    lastMonth: currentMonth,
                    lastYear: currentYear,
                    selectedUnits: Array.from(document.querySelectorAll('#company-grid-container .unit-checkbox:checked')).map(chk => chk.value)
                };
                localStorage.setItem(APP_STORAGE_KEY, JSON.stringify(dataToSave));
                showStatusMessage('Data saved!', 'success', document.getElementById('parse-status'), 2000);
            } catch (e) {
                showStatusMessage("Could not save data. Storage might be full or disabled.", 'error', document.getElementById('parse-status'));
            }
        }
        function loadDataForSpecificMonthYear(targetMonth, targetFullYear) {
            try {
                const savedDataJSON = localStorage.getItem(APP_STORAGE_KEY);
                if (savedDataJSON) {
                    const savedData = JSON.parse(savedDataJSON);
                    if (savedData.lastMonth === targetMonth && savedData.lastYear === targetFullYear) {
                        appState.newSchedule = savedData.newSchedule || [];
                        appState.usedPINs = new Set(savedData.usedPINs || []);
                        if (Array.isArray(savedData.selectedUnits)) {
                            deselectAllUnits(false);
                            savedData.selectedUnits.forEach(unitValue => {
                                const mainChk = document.querySelector(`#company-grid-container .unit-checkbox[value="${unitValue}"]`);
                                if (mainChk) mainChk.checked = true;
                            });
                            syncAllCompanySelectAllCheckboxes();
                            updateSelectedUnitsCountDisplay();
                        }
                        if (appState.newSchedule.length > 0 && appState.newSchedule.some(w => w && w.length && w.some(item => item.pin && item.pin !== FAILED_PIN_VALUE))) {
                            showStatusMessage(`Loaded PINs & selections for ${getMonthName(+targetMonth)} ${targetFullYear}.`, 'info', document.getElementById('parse-status'));
                            return true;
                        } else if (savedData.selectedUnits && savedData.selectedUnits.length)
                            showStatusMessage(`Loaded unit selections for ${getMonthName(+targetMonth)} ${targetFullYear}.`, 'info', document.getElementById('parse-status'));
                    }
                }
            } catch {
                showStatusMessage("Could not load saved data.", 'error', document.getElementById('parse-status'));
                localStorage.removeItem(APP_STORAGE_KEY);
            }
            return false;
        }
        function updatePrimaryColorRGBVariables() {
            const rootStyle = getComputedStyle(document.documentElement);
            const cssVar = (v) => rootStyle.getPropertyValue(v).trim();
            if (cssVar('--primary-color')) document.documentElement.style.setProperty('--primary-color-rgb', hexToRgbArray(cssVar('--primary-color')).join(', '));
            if (cssVar('--accent-color')) document.documentElement.style.setProperty('--accent-color-rgb', hexToRgbArray(cssVar('--accent-color')).join(', '));
            if (cssVar('--warning-color')) document.documentElement.style.setProperty('--warning-color-rgb', hexToRgbArray(cssVar('--warning-color')).join(', '));
        }

        // --- NEW: Saturday-to-Saturday Week Calculation ---
        function calculateWeekRanges(month, year) {
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            let ranges = [];

            // Find first Saturday in the month
            let firstSaturday = 1;
            for (let d = 1; d <= 7; d++) {
                if (new Date(year, month, d).getDay() === 6) { // 6 = Saturday
                    firstSaturday = d;
                    break;
                }
            }
            // If the month does not start on a Saturday, include 1st -> first Saturday as the first week
            if (firstSaturday > 1) {
                ranges.push({ start: 1, end: firstSaturday });
            }
            let start = firstSaturday + 1;
            while (start <= daysInMonth) {
                let end = start + 6;
                if (end > daysInMonth) end = daysInMonth;
                ranges.push({ start, end });
                start = end + 1;
            }
            return ranges;
        }

        function updateSelectedUnitsCountDisplay() {
            const selectedCount = document.querySelectorAll('#company-grid-container .unit-checkbox:checked').length;
            const displayElement = document.getElementById('selected-units-count-display');
            if (displayElement) displayElement.textContent = `(Selected: ${selectedCount})`;
            const globalSelectAllCheckbox = document.getElementById('global-select-all-units-checkbox');
            const allUnitCheckboxes = document.querySelectorAll('#company-grid-container .unit-checkbox');
            if (globalSelectAllCheckbox) {
                if (allUnitCheckboxes.length && selectedCount === allUnitCheckboxes.length) {
                    globalSelectAllCheckbox.checked = true;
                    globalSelectAllCheckbox.indeterminate = false;
                } else if (!selectedCount) {
                    globalSelectAllCheckbox.checked = false;
                    globalSelectAllCheckbox.indeterminate = false;
                } else {
                    globalSelectAllCheckbox.checked = false;
                    globalSelectAllCheckbox.indeterminate = true;
                }
            }
        }

        function updateMonthSelection(isNavigation = false) {
            const selectedMonthValue = document.getElementById('month-select').value,
                  selectedYearValue = document.getElementById('year-select').value;

            if (!isNavigation) {
                appState.newSchedule = [];
                appState.usedPINs.clear();
            }

            const dataLoadedForPINs = loadDataForSpecificMonthYear(selectedMonthValue, selectedYearValue);

            if (!dataLoadedForPINs && !isNavigation) {
                 appState.newSchedule = [];
                 appState.usedPINs.clear();
                showStatusMessage(`Ready for ${getMonthName(+selectedMonthValue)} '${selectedYearValue.slice(2)}.`, 'info', document.getElementById('parse-status'));
            }

            const exportCsvButton = document.getElementById('export-csv');
            const iphoneScreenshotButton = document.getElementById('iphone-screenshot-view');
            const hasValidPinsOnLoad = appState.newSchedule.length && appState.newSchedule.some(w => w && w.length && w.some(item => item.pin && item.pin !== FAILED_PIN_VALUE));

            if (hasValidPinsOnLoad) {
                 displayResults();
                 if (exportCsvButton) exportCsvButton.disabled = false;
                 if (iphoneScreenshotButton) iphoneScreenshotButton.disabled = false;
                 document.getElementById('results-output-card').style.display = 'block';
            } else {
                displayResults();
                if (exportCsvButton) exportCsvButton.disabled = true;
                if (iphoneScreenshotButton) iphoneScreenshotButton.disabled = true;
                const resultsCard = document.getElementById('results-output-card');
                resultsCard.style.display = resultsCard.classList.contains('expanded') ? 'block' : 'none';
            }
            updateSelectedUnitsCountDisplay();
            if (isNavigation || (!dataLoadedForPINs && !(localStorage.getItem(APP_STORAGE_KEY) && JSON.parse(localStorage.getItem(APP_STORAGE_KEY)).lastMonth === selectedMonthValue && JSON.parse(localStorage.getItem(APP_STORAGE_KEY)).lastYear === selectedYearValue))) {
                saveDataToLocalStorage();
            }
        }

        // PIN Generation
        function generateRandomPINValue() { return Math.floor(10000 + Math.random() * 90000); }
        function generateUniquePIN() {
            let newPIN, attempts = 0;
            while (attempts < MAX_PIN_GENERATION_ATTEMPTS) {
                newPIN = generateRandomPINValue();
                const pinStr = String(newPIN), pinPrefix = pinStr.substring(0, PIN_PREFIX_LENGTH);
                if (pinStr.length === PIN_LENGTH && !appState.usedPINs.has(newPIN) && !FORBIDDEN_PIN_PREFIXES.has(pinPrefix)) {
                    appState.usedPINs.add(newPIN);
                    return newPIN;
                }
                attempts++;
            }
            return null;
        }

        // --- PIN Generation Main Logic ---
        async function generateCorePINs(unitsForGeneration, buttonElement, operationName) {
            if (unitsForGeneration.length === 0) {
                showStatusMessage('No units to generate PINs for.', 'warning', document.getElementById('parse-status'));
                if (buttonElement) {
                    restoreLoadingButton(buttonElement);
                    buttonElement.classList.add('shake-button');
                    setTimeout(() => buttonElement.classList.remove('shake-button'), 500);
                }
                return;
            }
            showMatrixLoader(`GENERATING PINS FOR ${operationName.toUpperCase()}...`);
            if (buttonElement) {
                buttonElement.dataset.originalText = buttonElement.textContent;
                const loadingSpan = document.createElement('span');
                loadingSpan.className = 'loading';
                buttonElement.innerHTML = '';
                buttonElement.appendChild(loadingSpan);
                buttonElement.appendChild(document.createTextNode(`Generating...`));
                buttonElement.disabled = true;
            }
            await new Promise(resolve => setTimeout(resolve, 100));
            appState.newSchedule = [];
            appState.usedPINs.clear();

            const month = +document.getElementById('month-select').value,
                  year = +document.getElementById('year-select').value;
            const weekRanges = calculateWeekRanges(month, year);

            let allPinsGeneratedSuccessfully = true;
            for (const range of weekRanges) {
                const newWeekData = [];
                for (const unitName of unitsForGeneration) {
                    const generatedPin = generateUniquePIN();
                    if (generatedPin === null) allPinsGeneratedSuccessfully = false;
                    newWeekData.push({
                        unit: unitName,
                        weekIndex: weekRanges.indexOf(range),
                        dateRange: `${range.start}-${range.end}`,
                        pin: generatedPin === null ? FAILED_PIN_VALUE : generatedPin
                    });
                }
                appState.newSchedule.push(newWeekData);
            }
            hideMatrixLoader();
            if (buttonElement) restoreLoadingButton(buttonElement);

            if (!allPinsGeneratedSuccessfully) {
                showStatusMessage("Some PINs could not be generated. Try again!", 'error', document.getElementById('parse-status'));
            } else {
                showStatusMessage("PINs generated!", 'success', document.getElementById('parse-status'));
            }
            displayResults();
            saveDataToLocalStorage();
        }
        // ...rest of code: matrix loader, UI event handlers, helpers remain as before, reviewed for redundancy...

        // --- On Load ---
        document.addEventListener('DOMContentLoaded', function() {
            updatePrimaryColorRGBVariables();
            populateAllCompanyUnits();
            // ...rest of setup code as before...
        });

        // --- Utility: showStatusMessage, restoreLoadingButton, displayResults, deselectAllUnits, syncAllCompanySelectAllCheckboxes etc (unchanged or optimized) ---
        function showStatusMessage(message, type, targetElement, duration) {
            const el = targetElement || document.getElementById('parse-status');
            if (!el) return;
            el.className = `status ${type}`;
            el.textContent = message;
            el.style.display = 'block';
            if (duration !== undefined) setTimeout(() => { el.style.display = 'none'; }, duration);
        }
        function restoreLoadingButton(button) {
            if (button && button.dataset.originalText) {
                button.innerHTML = button.dataset.originalText;
                button.disabled = false;
            }
        }
        function displayResults() {
            // ... (Unchanged: updates the table and result cards as before)
        }
        function deselectAllUnits(updateDisplay = true) {
            document.querySelectorAll('#company-grid-container .unit-checkbox').forEach(cb => { cb.checked = false; });
            if (updateDisplay) updateSelectedUnitsCountDisplay();
        }
        function syncAllCompanySelectAllCheckboxes() {
            // ... (Unchanged: logic for syncing select-all checkboxes)
        }
        // ... (Any other utility functions necessary, keep as concise as possible) ...

        // --- Matrix loader and other UI logic remain unchanged and optimized for brevity ---

    })();
    </script>
</body>
</html>
